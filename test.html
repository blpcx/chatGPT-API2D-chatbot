<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Local Chat App</title>
  <style>
    body {
      background-color: #f0f0f0;
      font-family: 'Helvetica Neue', sans-serif;
    }

    .container {
      width: 1250px;
      height: 650px;
      margin: 0 auto;
      padding-top: 20px;
      padding-bottom: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0px 0px 10px #bbb;
    }

    .input {
      width: 99%;
      margin-bottom: 10px;
      padding: 5px;
      font-size: 16px;
      border: 1px solid #bbb;
      border-radius: 5px;
      outline: none;
    }

    .button {
      display: block;
      width: 5%;
      margin: 0 auto;
      margin-top: 10px;
      padding: 8px;
      background-color: #2196F3;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .output {
      height: 75%;
      margin-top: 20px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #bbb;
      border-radius: 5px;
      overflow-y: scroll;
      scrollbar-width: thin;
    }

    .new-chat {
      text-align: center;
      display: block;
      width: 5%;
      margin: 0 auto;
      margin-top: 10px;
      padding: 8px;
      background-color: #2196F3;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .output pre {
      margin: 0;
      padding: 0;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      word-wrap: break-word;
      line-height: 1.5em;
    }

    .output pre * {
      margin: 0;
      padding: 0;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
    }

    .message {
      white-space: pre-wrap;
      background-color: rgba(152, 251, 152, 0.3);
    }

    .response {
      white-space: pre-wrap;
      background-color: rgba(135, 206, 250,0.5);
    }

    .user-message {
      background-color: rgba(152, 251, 152, 0.3);
    }

    .bot-message {
      background-color: rgba(135, 206, 250,0.5);
    }
  </style>
</head>

<body>
  <div class="container">
    <input class="input" id="inputBox" type="text" placeholder="输入你的问题...">
    <button class="button" id="sendBtn">发送</button>
    <div class="output" id="outputBox"></div>
    <a class="new-chat" id="newChat">新对话</a>
  </div>
  <script>
    // JavaScript代码
    const apiUrl = "https://openai.api2d.net/v1/chat/completions";
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer {}'
    };
    let sessionId = null;
    const inputBox = document.getElementById("inputBox");
    const sendBtn = document.getElementById("sendBtn");
    const outputBox = document.getElementById("outputBox");
    const newChat = document.getElementById("newChat");
    function sendMessage(message) {
      let data = {
        "model": "gpt-3.5-turbo-0301",
        "messages": [{ "role": "user", "content": message }],
        "temperature": 0.5,
      };
      if (sessionId !== null) {
        data.session_id = sessionId;
      }
      return fetch(apiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(data)
      }).then(response => response.json()).then(result => {
        console.log(result);
        sessionId = result.session_id;
        return result.choices[0].message.content.trim();
      });
    }
    function sendMsg() {
      let message = inputBox.value;
      if (message === '') {
        return;
      }
      // 在输出框中添加“生成中”提示消息
      let messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.textContent = message;
      outputBox.appendChild(messageDiv);
      let responseDiv = document.createElement('div');
      responseDiv.classList.add('response');
      responseDiv.textContent = '生成中...';
      outputBox.appendChild(responseDiv);
      sendMessage(message).then(response => {
        // 删除“生成中”提示消息
        outputBox.removeChild(messageDiv);
        outputBox.removeChild(responseDiv);
        let formattedResponse = response.split('\n').map(line => line.trim()).join('<br>');
        let formattedMessage = message.split('\n').map(line => line.trim()).join('<br>');
        outputBox.insertAdjacentHTML('beforeend', `<pre><strong>你：</strong></pre><ul class="user-message">${formattedMessage}</ul>
            <pre><strong>gpt-3.5-turbo-0301：</strong></pre><ul class="bot-message">${formattedResponse.split('\n').map(line => `<li>${line}</li>`).join('')}</ul>`);
        // 自动滚动输出框
        outputBox.scrollTop = outputBox.scrollHeight;
      }).catch(error => {
        console.error(error);
      });

      inputBox.value = '';
    }
    sendBtn.addEventListener('click', sendMsg);
    inputBox.addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        // 只有在输入框非空的情况下才能发送消息
        if (inputBox.value.trim() !== "") {
          sendMsg();
        }
      }
    });
    newChat.addEventListener('click', () => {
      sessionId = null;
      inputBox.value = '';
      outputBox.innerHTML = '';
    });
  </script>
</body>

</html>
